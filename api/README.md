# API

The api is built upon nodejs, with express.
It provides endpoints for the angular frontend.
It retrieves data from a mysql database.

*The api listens on port 3000.*

- [API Endpoints](#api-endpoints)
- [Database and Example Queries](#mysql-database)

## API Endpoints

### **GET '/'**
Basic endpoint for testing. 

Responds with 'hey'

### **GET '/api/games/:game_id'**
Used to return a lot of data about a specific game, including the map information, participating players, and their stats. If the game is a duel, it will attach additional duel data to each player 

Given an integer game id, returns data in the shape of `FullGame` as defined in [interfaces.ts](../src/app/interfaces.ts)

### **GET '/api/games'**
Used for browsing the list of games.

Accepts query parameters such as `map`, `gametype`, `player_name`, and `offset`, and returns data in the shape of `Game` as defined in [interfaces.ts](../src/app/interfaces.ts)

### **GET '/api/playerInfo/:player_name'**
Given a player's `colored_name`, returns 10 of their recent games, along with totals of their score, frags, deaths, damage taken, and damage received.

Returns data in the shape of `AdvancedPlayerPreview` as defined in [interfaces.ts](../src/app/interfaces.ts)

### **GET '/api/gametypes'**
Used for getting a list of all unique gametypes in the database.


### **GET '/api/players'**
Used for browsing the list of players.

Accepts query parameters `offset`, and `limit`. Returns a list of players with their respective game counts. If query parameter `name` is provided, it will only return players that have a similar name.

Returns data in the shape of `PlayerPreview` as defined in [interfaces.ts](../src/app/interfaces.ts)

### **GET '/api/playersInGame/:game_id'**
Used for getting the names of participating players in a given game. Useful for displaying a small preview on the game-browser page.


## MySQL Database
If you wish to play around with some cool data, you can use the already existing `database-dump.sql`
Alternatively, you can populate the database with your own match reports by using populate.js
Just create a directory called `reports` and fill it with match reports (.json files) generated by Warmama. Then you can `node populate.js` (assuming the script is set up correctly)

The database schema is available in this directory: [database-schema.jpg](./database-schema.jpg)

## **Example Queries**

### Getting every game in the database
```
SELECT * FROM games;
```

### Getting names of players from a specific game
```
SELECT players.name FROM games
INNER JOIN players ON games.id=players.game_id
WHERE games.id = 25;
```

### Getting additional player stats from a specific game
```
SELECT players.name, p_stats.score, p_stats.frags, p_stats.deaths, p_stats.dmg_given, p_stats.dmg_taken
FROM games
INNER JOIN players ON games.id=players.game_id
INNER JOIN p_stats ON players.id=p_stats.player_id
WHERE games.id = 25;
```

### Getting a player's weapon stats for a specific game
(I would recommend creating a procedure for this that accepts a player id)
```
SELECT shots_hit, shots_fired, damage, frags, 'RL' AS name FROM RL
WHERE player_id = 200
UNION ALL
SELECT shots_hit, shots_fired, damage, frags, 'LG' AS name FROM LG
WHERE player_id = 200
UNION ALL
SELECT shots_hit, shots_fired, damage, frags, 'EB' AS name FROM EB
WHERE player_id = 200
UNION ALL
SELECT shots_hit, shots_fired, damage, frags, 'GL' AS name FROM GL
WHERE player_id = 200
UNION ALL
SELECT shots_hit, shots_fired, damage, frags, 'MG' AS name FROM MG
WHERE player_id = 200
UNION ALL
SELECT shots_hit, shots_fired, damage, frags, 'RG' AS name FROM RG
WHERE player_id = 200
UNION ALL
SELECT shots_hit, shots_fired, damage, frags, 'PG' AS name FROM PG
WHERE player_id = 200
UNION ALL
SELECT shots_hit, shots_fired, damage, frags, 'GB' AS name FROM GB
WHERE player_id = 200;
```

### Getting every server and their respective game counts in descending order
```
SELECT hostname, count(hostname) AS game_count FROM games
GROUP BY hostname
ORDER BY game_count DESC;
```

### Getting all of a player's games
```
SELECT games.id FROM games
INNER JOIN players ON games.id=players.game_id
WHERE players.name="Player Name";
```

The above query is a perfect example of why there are both `name` and `colored_name` columns in the `players` table - it makes it very easy to look up a player by name!


### Getting the most popular maps
```
SELECT map, count(map) AS game_count FROM games
GROUP BY map
ORDER BY game_count DESC;
```

### Getting the most popular gametypes
```
SELECT gametype, count(gametype) AS game_count FROM games
GROUP BY gametype
ORDER BY game_count DESC;
```